<!--
 * @Author: your name
 * @Date: 2020-12-11 19:47:10
 * @LastEditTime: 2020-12-11 21:32:01
 * @LastEditors: Please set LastEditors
 * @Description: In User Settings Edit
 * @FilePath: \webRTC\public\views.html
-->
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>播放屏幕分享</title>
</head>
<body>
	<video id="vid" autoplay muted></video>
    <button class="start">开始</button>
    <button class="stop">停止</button>
	<script>
		const remoteVideo = document.querySelector("#vid");
        const start = document.querySelector(".start");
        const stop = document.querySelector(".stop");
        let stereo = false; // sdp

		async function createConnection(){
            const response1 = await fetch('/connections/view',{method: 'POST'});
            const { id, localDescription} = await response1.json();
            const localPeerConnection = new RTCPeerConnection({
                sdpSemantics: 'unified-plan'
            });
            localPeerConnection.close = function () {
                fetch(`/connections/view/${id}`, {method: 'DELETE'}).catch((err)=>console.log(err));
                return RTCPeerConnection.prototype.close.apply(this, arguments);
            }
            try {
                await localPeerConnection.setRemoteDescription(localDescription);
                await beforeAnswer(localPeerConnection);
                const originalAnswer = await localPeerConnection.createAnswer();
                const updatedAnswer = new RTCSessionDescription({
                    type: 'answer',
                    sdp: stereo ? enableStereoOpus(originalAnswer.sdp) : originalAnswer.sdp
                });
                await localPeerConnection.setLocalDescription(updatedAnswer);
                await fetch(`/connections/view/${id}/remote-description`, {
                    method: 'POST',
                    body: JSON.stringify(localPeerConnection.localDescription),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                return localPeerConnection;
            } catch(e){
                localPeerConnection.close();
                console.log(e);
            }
        }

        async function beforeAnswer(peerConnection){
        	const remoteStream = new MediaStream(peerConnection.getReceivers().map(receiver => receiver.track));
        	remoteVideo.srcObject = remoteStream;
        	const { close } = peerConnection;
        	peerConnection.close = function(){
        		remoteVideo.srcObject = null;
        		return close.apply(this, arguments);
        	}
        }

        function enableStereoOpus(sdp) {
            return sdp.replace(/a=fmtp:111/, 'a=fmtp:111 stereo=1\r\na=fmtp:111');
        }

        let peerConnection = null;
        start.addEventListener('click', async ()=>{
            peerConnection = await createConnection();
        });

        stop.addEventListener('click', ()=>{
            peerConnection.close();
        })
	</script>
</body>
</html>